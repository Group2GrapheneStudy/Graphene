@model GrapheneTrace.Web.Controllers.DashboardController.PatientViewModel
@{
    ViewData["Title"] = "Patient Dashboard";
}

<style>
    .stat-card {
        transition: transform .15s ease, box-shadow .15s ease;
    }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 .75rem 1.5rem rgba(0, 0, 0, 0.06);
        }

    .status-pill {
        display: inline-flex;
        align-items: center;
        padding: 0.15rem 0.65rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .status-pill.low {
        background-color: #e3f9e5;
        color: #1b6b3a;
    }

    .status-pill.medium {
        background-color: #fff4cc;
        color: #996c00;
    }

    .status-pill.high {
        background-color: #ffe3e3;
        color: #b00020;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3 class="mb-0">Welcome, @Model.PatientName</h3>
        <small class="text-muted">Your Graphene Trace pressure overview</small>
    </div>
</div>

<!-- TOP METRICS ROW -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card stat-card text-bg-light h-100">
            <div class="card-body">
                <h6>Pressure Risk Score</h6>
                <h2>@Model.PressureRiskScore</h2>
                <p class="mb-0 small text-muted">@Model.PressureRiskLabel</p>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body">
                <h6>Peak Pressure Index (PPI)</h6>
                <h2>
                    @(Model.CurrentPpi.HasValue? Model.CurrentPpi.Value.ToString() : "N/A")
                </h2>
                <p class="mb-0 small text-muted">
                    Latest reading from your graphene cushion
                </p>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body">
                <h6>Contact Area</h6>
                <h2>
                    @(Model.CurrentContactArea.HasValue? Model.CurrentContactArea.Value.ToString("0.0") + "%" : "N/A")
                </h2>
                <p class="mb-0 small text-muted">
                    Percentage of sensor area currently under load
                </p>
            </div>
        </div>
    </div>
</div>

<!-- TREND + RANGE SELECTION -->
<div class="card stat-card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <h6 class="mb-0">Pressure Trend</h6>
            <small class="text-muted">@Model.TimeRangeLabel</small>
        </div>
        <div class="btn-group btn-group-sm" role="group" aria-label="Time range">
            <a asp-action="Patient"
               asp-controller="Dashboard"
               asp-route-range="1h"
               class="btn btn-outline-secondary @(Model.TimeRange == "1h" ? "active" : "")">
                1h
            </a>
            <a asp-action="Patient"
               asp-controller="Dashboard"
               asp-route-range="6h"
               class="btn btn-outline-secondary @(Model.TimeRange == "6h" ? "active" : "")">
                6h
            </a>
            <a asp-action="Patient"
               asp-controller="Dashboard"
               asp-route-range="24h"
               class="btn btn-outline-secondary @(Model.TimeRange == "24h" ? "active" : "")">
                24h
            </a>
            <a asp-action="Patient"
               asp-controller="Dashboard"
               asp-route-range="all"
               class="btn btn-outline-secondary @(Model.TimeRange == "all" ? "active" : "")">
                All
            </a>
        </div>
    </div>
    <div class="card-body">
        <canvas id="pressureChart"></canvas>
    </div>
</div>

<!-- Upcoming appointments -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Upcoming Appointments (@Model.UpcomingAppointments.Count)</strong>
    </div>
    <div class="card-body p-0">
        @if (!Model.UpcomingAppointments.Any())
        {
            <p class="m-3 text-muted">You have no upcoming appointments scheduled.</p>
        }
        else
        {
            <table class="table table-sm mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Clinician</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var appt in Model.UpcomingAppointments)
                    {
                        <tr>
                            <td>@appt.StartTime.ToString("dd MMM yyyy")</td>
                            <td>@appt.StartTime.ToString("HH:mm") – @appt.EndTime.ToString("HH:mm")</td>
                            <td>@appt.ClinicianName</td>
                            <td>@appt.Status</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<!-- Active + recent alerts -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <strong>Active Alerts (@Model.ActiveAlerts.Count)</strong>
            </div>
            <div class="card-body p-0">
                @if (!Model.ActiveAlerts.Any())
                {
                    <p class="m-3 text-muted">No active alerts.</p>
                }
                else
                {
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Severity</th>
                                <th>Message</th>
                                <th>Raised</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var al in Model.ActiveAlerts)
                            {
                                var sevClass = al.Severity switch
                                {
                                    "High" => "table-danger",
                                    "Medium" => "table-warning",
                                    "Low" => "table-info",
                                    _ => ""
                                };

                                <tr class="@sevClass">
                                    <td>@al.Severity</td>
                                    <td>@al.Message</td>
                                    <td>@al.RaisedAt.ToString("dd MMM HH:mm")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <strong>Recent Alerts</strong>
            </div>
            <div class="card-body p-0">
                @if (!Model.RecentAlerts.Any())
                {
                    <p class="m-3 text-muted">No recent alerts.</p>
                }
                else
                {
                    <ul class="list-group list-group-flush">
                        @foreach (var al in Model.RecentAlerts)
                        {
                            <li class="list-group-item d-flex justify-content-between">
                                <div>
                                    <strong>@al.Severity</strong> – @al.Message
                                </div>
                                <span class="text-muted small">@al.RaisedAt.ToString("dd MMM HH:mm")</span>
                            </li>
                        }
                    </ul>
                }
            </div>
        </div>
    </div>
</div>

<!-- Feedback -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Your Feedback</strong>
    </div>
    <div class="card-body">
        @if (!Model.MyFeedback.Any())
        {
            <p class="text-muted mb-0">You have not left any feedback yet.</p>
        }
        else
        {
            <ul class="list-group list-group-flush">
                @foreach (var f in Model.MyFeedback)
                {
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <span>
                                <strong>@f.ClinicianName</strong> – rated @f.Rating/5
                            </span>
                            <span class="text-muted small">@f.CreatedAt.ToString("dd MMM yyyy")</span>
                        </div>
                        <div>@f.Comment</div>
                    </li>
                }
            </ul>
        }
    </div>
</div>

<!-- Patient ↔ Clinician messages -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">Messages with clinicians</h5>
                <small class="text-muted">
                    Any clinician can see and reply to your messages.
                </small>
            </div>
        </div>
    </div>

    <div class="card-body">
        <!-- Conversation history -->
        <div class="mb-3" style="max-height:300px; overflow-y:auto;">
            @if (Model.Conversation != null && Model.Conversation.Any())
            {
                @foreach (var m in Model.Conversation)
                {
                    var isPatient = m.FromRole == "Patient";

                    <div class="mb-2">
                        <div class="small text-muted">
                            <strong>@(isPatient ? "You" : m.ClinicianName)</strong>
                            <span class="ms-1">@m.SentAt.ToString("dd MMM HH:mm")</span>
                        </div>
                        <div class="p-2 rounded @(isPatient ? "bg-primary text-white" : "bg-light")">
                            @m.Text
                        </div>
                    </div>
                }
            }
            else
            {
                <p class="text-muted">No messages yet. Use the box below to contact your clinician.</p>
            }
        </div>

        <!-- New message form -->
        <form asp-controller="Dashboard"
              asp-action="SendMessageToClinician"
              method="post">
            @Html.AntiForgeryToken()
            <div class="mb-2">
                <textarea name="text"
                          class="form-control"
                          rows="3"
                          placeholder="Type a message for your clinician"></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-sm">
                Send message
            </button>
        </form>

        @if (TempData["PatientMessage"] != null)
        {
            <div class="alert alert-info alert-dismissible fade show mt-2" role="alert">
                @TempData["PatientMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var trendData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.PressureTrend));
        var labels = trendData.map(function (_, idx) { return (idx + 1).toString(); });

        var ctx = document.getElementById('pressureChart').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Peak pressure over time',
                    data: trendData,
                    borderColor: '#e63946',
                    tension: 0.3
                }]
            }
        });
    </script>
}
