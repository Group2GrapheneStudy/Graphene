@model GrapheneTrace.Web.Controllers.DashboardController.PatientViewModel
@{
    ViewData["Title"] = "Patient Dashboard";
}

<style>
    .stat-card {
        transition: transform .15s ease, box-shadow .15s ease;
    }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 .75rem 1.5rem rgba(0, 0, 0, 0.06);
        }

    .status-pill {
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .chart-container {
        position: relative;
        height: 250px;
    }
</style>

<h1 class="mb-4">Welcome, @Model.PatientName</h1>

<!-- 🔥 NEW PRESSURE ALERT BANNER (added section) -->
@if (Model.ActiveAlerts != null && Model.ActiveAlerts.Any())
{
    var latest = Model.ActiveAlerts.OrderByDescending(a => a.RaisedAt).First();

    <div class="alert alert-warning d-flex justify-content-between align-items-center mb-4">
        <div>
            <strong>Active pressure alert detected.</strong>
            <span class="ms-1">
                Latest: <strong>@latest.Severity</strong> at
                @latest.RaisedAt.ToString("dd MMM HH:mm").
            </span>
        </div>
        <a href="#alerts-panel" class="btn btn-sm btn-outline-dark">View alerts</a>
    </div>
}
else
{
    <div class="alert alert-success mb-4">
        <strong>No active pressure alerts.</strong> Your readings look normal today.
    </div>
}
<!-- END NEW SECTION -->

<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card stat-card text-bg-light h-100">
            <div class="card-body">
                <h6>Pressure Risk Score</h6>
                <h2>@Model.PressureRiskScore</h2>
                <p class="mb-0 small text-muted">@Model.PressureRiskLabel</p>
            </div>
        </div>
    </div>

    <div class="col-md-8 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body">
                <h6 class="mb-3">Pressure Trend (last 7 readings)</h6>
                <canvas id="pressureChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Upcoming appointments -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Upcoming Appointments (@Model.UpcomingAppointments.Count)</strong>
    </div>
    <div class="card-body p-0">
        @if (!Model.UpcomingAppointments.Any())
        {
            <p class="m-3 text-muted">No upcoming appointments.</p>
        }
        else
        {
            <table class="table table-sm mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Clinician</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var a in Model.UpcomingAppointments)
                    {
                        <tr>
                            <td>@a.StartTime.ToString("yyyy-MM-dd")</td>
                            <td>@a.StartTime.ToString("HH:mm") – @a.EndTime.ToString("HH:mm")</td>
                            <td>@a.ClinicianName</td>
                            <td>@a.Status</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<!-- Active Alerts -->
<div id="alerts-panel" class="card mb-4">
    <div class="card-header">
        <strong>Active Alerts (@Model.ActiveAlerts.Count)</strong>
    </div>
    <div class="card-body p-0">
        @if (!Model.ActiveAlerts.Any())
        {
            <p class="m-3 text-muted">No active alerts.</p>
        }
        else
        {
            <table class="table table-sm mb-0">
                <thead>
                    <tr>
                        <th>Severity</th>
                        <th>Message</th>
                        <th>Raised</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var al in Model.ActiveAlerts)
                    {
                        var sevClass = al.Severity switch
                        {
                            "High" => "table-danger",
                            "Medium" => "table-warning",
                            "Low" => "table-info",
                            _ => ""
                        };

                        <tr class="@sevClass">
                            <td>@al.Severity</td>
                            <td>@al.Message</td>
                            <td>@al.RaisedAt.ToString("dd MMM HH:mm")</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<!-- Recent Alerts -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Recent Alerts</strong>
    </div>
    <div class="card-body p-0">
        @if (!Model.RecentAlerts.Any())
        {
            <p class="m-3 text-muted">No alert history found.</p>
        }
        else
        {
            <ul class="list-group list-group-flush">
                @foreach (var al in Model.RecentAlerts)
                {
                    <li class="list-group-item d-flex justify-content-between">
                        <span>
                            <strong>@al.Severity</strong> – @al.Message
                        </span>
                        <span class="text-muted">@al.RaisedAt.ToString("dd MMM HH:mm")</span>
                    </li>
                }
            </ul>
        }
    </div>
</div>

<!-- Prescriptions -->
<div class="card mb-4">
    <div class="card-header"><strong>Prescriptions</strong></div>
    <div class="card-body p-0">
        @if (!Model.Prescriptions.Any())
        {
            <p class="m-3 text-muted">No prescriptions recorded.</p>
        }
        else
        {
            <ul class="list-group list-group-flush">
                @foreach (var p in Model.Prescriptions)
                {
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <strong>@p.Medication</strong>
                            <span class="text-muted">@p.CreatedAt.ToString("dd MMM")</span>
                        </div>
                        <div>@p.Dosage</div>
                        <div class="text-muted small">@p.ClinicianName</div>
                        <div>@p.Notes</div>
                    </li>
                }
            </ul>
        }
    </div>
</div>

<!-- Feedback -->
<div class="card mb-5">
    <div class="card-header">
        <strong>My Feedback</strong>
    </div>
    <div class="card-body">
        @if (!Model.MyFeedback.Any())
        {
            <p class="text-muted">You have not left any feedback yet.</p>
        }
        else
        {
            <ul class="list-group list-group-flush">
                @foreach (var f in Model.MyFeedback)
                {
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <span>@f.ClinicianName – @f.Rating/5</span>
                            <span class="text-muted">@f.CreatedAt.ToString("dd MMM")</span>
                        </div>
                        <div>@f.Comment</div>
                    </li>
                }
            </ul>
        }
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var ctx = document.getElementById('pressureChart').getContext('2d');
    var chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['1','2','3','4','5','6','7'],
            datasets: [{
                label: 'Pressure Level',
                data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.PressureTrend)),
                borderColor: '#e63946',
                tension: 0.3
            }]
        }
    });
</script>
