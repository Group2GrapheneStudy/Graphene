@model GrapheneTrace.Web.Controllers.DashboardController.ClinicianViewModel
@{
    ViewData["Title"] = "Clinician Dashboard";
}

<style>
    .stat-card {
        transition: transform .15s ease, box-shadow .15s ease;
    }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 .75rem 1.5rem rgba(0, 0, 0, 0.06);
        }

    .status-pill {
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .chart-container {
        position: relative;
        height: 250px;
    }
</style>

<h1 class="mb-4">Welcome, @Model.ClinicianName</h1>

@{
    var highCount = Model.ActiveAlerts?.Count(a => a.Severity == "High") ?? 0;
    var medCount = Model.ActiveAlerts?.Count(a => a.Severity == "Medium") ?? 0;
    var lowCount = Model.ActiveAlerts?.Count(a => a.Severity == "Low") ?? 0;
}

<!-- PRESSURE ALERT BANNER -->
@if (Model.ActiveAlerts != null && Model.ActiveAlerts.Any())
{
    <div class="alert alert-danger d-flex justify-content-between align-items-center mb-4">
        <div>
            <strong>Active pressure alerts for your patients.</strong>
            <span class="ms-1">
                High: <strong>@highCount</strong>,
                Medium: <strong>@medCount</strong>,
                Low: <strong>@lowCount</strong>.
            </span>
        </div>
        <a href="#alerts-panel" class="btn btn-sm btn-outline-light">Review alerts</a>
    </div>
}
else
{
    <div class="alert alert-success mb-4">
        <strong>No active pressure alerts.</strong> All monitored patients appear stable.
    </div>
}

<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card stat-card text-bg-light h-100">
            <div class="card-body">
                <h6>Today's Appointments</h6>
                <h2>@Model.TodayAppointmentsCount</h2>
                <p class="mb-0 small text-muted">Scheduled for @DateTime.Today.ToString("dd MMM yyyy")</p>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card stat-card text-bg-light h-100">
            <div class="card-body">
                <h6>Upcoming Appointments</h6>
                <h2>@Model.UpcomingAppointmentsCount</h2>
                <p class="mb-0 small text-muted">Next few days</p>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body">
                <h6>Active Pressure Alerts</h6>
                <h2>@(Model.ActiveAlerts?.Count ?? 0)</h2>
                <p class="mb-0 small text-muted">Across your monitored patients</p>
            </div>
        </div>
    </div>
</div>

<!-- CLINICIAN SELECTOR -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Your Clinician Profile</strong>
    </div>
    <div class="card-body">
        <form method="get" asp-action="Clinician" class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Select Clinician</label>
                <select name="selectedClinician" class="form-select">
                    @foreach (var c in Model.Clinicians)
                    {
                        if (Model.SelectedClinician == c)
                        {
                            <option value="@c" selected>@c</option>
                        }
                        else
                        {
                            <option value="@c">@c</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <button class="btn btn-primary">Switch</button>
            </div>
        </form>
    </div>
</div>

<!-- TODAY'S APPOINTMENTS -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Today's Appointments (@Model.TodayAppointments.Count)</strong>
    </div>
    <div class="card-body p-0">
        @if (Model.TodayAppointments == null || !Model.TodayAppointments.Any())
        {
            <p class="m-3 text-muted">No appointments scheduled for today.</p>
        }
        else
        {
            <table class="table table-sm mb-0">
                <thead>
                    <tr>
                        <th>Patient</th>
                        <th>Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var a in Model.TodayAppointments)
                    {
                        <tr>
                            <td>@a.PatientName</td>
                            <td>@a.StartTime.ToString("HH:mm") – @a.EndTime.ToString("HH:mm")</td>
                            <td>@a.Status</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<!-- UPCOMING APPOINTMENTS -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Upcoming Appointments (@Model.UpcomingAppointments.Count)</strong>
    </div>
    <div class="card-body p-0">
        @if (Model.UpcomingAppointments == null || !Model.UpcomingAppointments.Any())
        {
            <p class="m-3 text-muted">No upcoming appointments.</p>
        }
        else
        {
            <table class="table table-sm mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Patient</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var a in Model.UpcomingAppointments)
                    {
                        <tr>
                            <td>@a.StartTime.ToString("yyyy-MM-dd")</td>
                            <td>@a.StartTime.ToString("HH:mm") – @a.EndTime.ToString("HH:mm")</td>
                            <td>@a.PatientName</td>
                            <td>@a.Status</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<!-- PATIENT LIST -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Patients Under Your Care (@(Model.Patients?.Count ?? 0))</strong>
    </div>
    <div class="card-body">
        @if (Model.Patients == null || !Model.Patients.Any())
        {
            <p class="text-muted">No active patients assigned to you.</p>
        }
        else
        {
            <ul class="list-group">
                @foreach (var p in Model.Patients)
                {
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>@p.FullName</strong>
                        <span class="text-muted small">Assigned</span>
                    </li>
                }
            </ul>
        }
    </div>
</div>

<!-- PRESSURE ALERTS TABLE -->
<div id="alerts-panel" class="card mb-4">
    <div class="card-header">
        <strong>Active Pressure Alerts (@(Model.ActiveAlerts?.Count ?? 0))</strong>
    </div>
    <div class="card-body p-0">
        <table class="table table-sm mb-0">
            <thead>
                <tr>
                    <th>Patient</th>
                    <th>Severity</th>
                    <th>Message</th>
                    <th>Raised</th>
                    <th>Resolved</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.ActiveAlerts != null && Model.ActiveAlerts.Any())
                {
                    @foreach (var a in Model.ActiveAlerts)
                    {
                        var sevClass = a.Severity switch
                        {
                            "High" => "table-danger",
                            "Medium" => "table-warning",
                            "Low" => "table-info",
                            _ => ""
                        };

                        <tr class="@sevClass">
                            <td>@a.PatientName</td>
                            <td>@a.Severity</td>
                            <td>@a.Message</td>
                            <td>@a.RaisedAt.ToString("dd MMM HH:mm")</td>
                            <td>@(a.IsResolved ? "Yes" : "No")</td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="text-muted">No active alerts for these patients.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- MESSAGES -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Patient messages</h5>
        <span class="badge bg-secondary">
            @(Model.InboxMessages?.Count ?? 0)
        </span>
    </div>

    <div class="card-body">
        <div class="mb-3" style="max-height:320px; overflow-y:auto;">
            @if (Model.InboxMessages != null && Model.InboxMessages.Any())
            {
                @foreach (var msg in Model.InboxMessages.OrderByDescending(m => m.SentAt))
                {
                    <div class="border rounded p-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>@msg.PatientName</strong>
                                <span class="small text-muted">(@msg.FromRole)</span>
                            </div>
                            <small class="text-muted">@msg.SentAt.ToString("g")</small>
                        </div>
                        <div>@msg.Text</div>
                    </div>
                }
            }
            else
            {
                <p class="text-muted mb-0">No messages yet.</p>
            }
        </div>

        <hr />

        <h6>Reply to a patient</h6>
        <form asp-controller="Dashboard" asp-action="SendMessageToPatient" method="post">
            @Html.AntiForgeryToken()

            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Patient ID</label>
                    <input type="number" name="patientId" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label class="form-label">Message</label>
                    <textarea name="text" class="form-control" rows="2"></textarea>
                </div>

                <div class="col-md-2 d-grid">
                    <button type="submit" class="btn btn-primary">Send</button>
                </div>
            </div>
        </form>

        @if (TempData["ClinicianMessage"] != null)
        {
            <div class="alert alert-info mt-3">
                @TempData["ClinicianMessage"]
            </div>
        }
    </div>
</div>

<!-- PRESCRIPTIONS -->
<div class="card mb-5">
    <div class="card-header">
        <strong>Prescriptions You Have Issued</strong>
    </div>
    <div class="card-body">
        @if (Model.RecentPrescriptions == null || !Model.RecentPrescriptions.Any())
        {
            <p class="text-muted">No prescriptions recorded yet.</p>
        }
        else
        {
            <ul class="list-group list-group-flush">
                @foreach (var p in Model.RecentPrescriptions)
                {
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <span><strong>@p.Medication</strong> – @p.Dosage</span>
                            <span class="text-muted">@p.CreatedAt.ToString("dd MMM")</span>
                        </div>
                        <div>Patient: @p.PatientName</div>
                        <div>@p.Notes</div>
                    </li>
                }
            </ul>
        }
    </div>
</div>
